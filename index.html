<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom QR Code Generator</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    canvas { margin-top: 20px; border: 1px solid #ddd; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Custom QR Code Generator</h2>

  <label>Enter Text/URL:
    <input type="text" id="qrText" placeholder="Enter text or URL">
  </label>
  <label>Choose File:
    <input type="file" id="imageUpload" accept="image/*">
  </label>
  <label>Center Text:
    <input type="text" id="centerText" placeholder="Optional text">
  </label>
  <label>Font Size:
    <input type="number" id="fontSize" value="20">
  </label>
  <label>Safe Zone Shape:
    <select id="safeShape">
      <option value="auto">Auto</option>
      <option value="circle">Circle</option>
      <option value="rectangle">Rectangle</option>
    </select>
  </label>
  <label>Safe Zone Width:
    <input type="number" id="safeWidth" placeholder="auto">
  </label>
  <label>Safe Zone Height:
    <input type="number" id="safeHeight" placeholder="auto">
  </label>
  <br>
  <button onclick="generateQR()">Generate QR Code</button>
  <button onclick="downloadQR()">Download</button>
  <button onclick="resetQR()">Reset</button>

  <br>
  <canvas id="qrCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
  <script>
    let uploadedImage = null;

    document.getElementById('imageUpload').addEventListener('change', function (e) {
      const reader = new FileReader();
      reader.onload = function (event) {
        uploadedImage = new Image();
        uploadedImage.src = event.target.result;
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    function generateQR() {
      const text = document.getElementById("qrText").value || " ";
      const centerText = document.getElementById("centerText").value;
      const fontSize = parseInt(document.getElementById("fontSize").value);
      const shape = document.getElementById("safeShape").value;
      let safeW = parseInt(document.getElementById("safeWidth").value) || 0;
      let safeH = parseInt(document.getElementById("safeHeight").value) || 0;

      const qr = qrcode(0, 'H');
      qr.addData(text);
      qr.make();

      const canvas = document.getElementById("qrCanvas");
      const ctx = canvas.getContext("2d");

      const moduleCount = qr.getModuleCount();
      const moduleSize = 6;
      const size = moduleCount * moduleSize;
      canvas.width = canvas.height = size;

      ctx.clearRect(0, 0, size, size);
      ctx.imageSmoothingEnabled = false;

      // Auto safe zone if no size provided
      if (!safeW || !safeH) {
        if (uploadedImage) {
          safeW = uploadedImage.width + 8;
          safeH = uploadedImage.height + 8;
        } else if (centerText) {
          ctx.font = `${fontSize}px Arial`;
          const textWidth = ctx.measureText(centerText).width;
          safeW = textWidth + 8;
          safeH = fontSize + 8;
        } else {
          safeW = safeH = 50; // default fallback
        }
      }

      const cx = size / 2;
      const cy = size / 2;

      // Draw QR code modules
      ctx.fillStyle = "#000";
      for (let r = 0; r < moduleCount; r++) {
        for (let c = 0; c < moduleCount; c++) {
          if (!qr.isDark(r, c)) continue;

          const x = c * moduleSize + moduleSize / 2;
          const y = r * moduleSize + moduleSize / 2;
          let inside = false;

          if (shape === "rectangle") {
            inside = (x > cx - safeW / 2 && x < cx + safeW / 2 &&
                      y > cy - safeH / 2 && y < cy + safeH / 2);
          } else if (shape === "circle" || shape === "auto") {
            const dx = x - cx;
            const dy = y - cy;
            const radius = Math.max(safeW, safeH) / 2;
            inside = (dx * dx + dy * dy < radius * radius);
          }

          if (!inside) {
            ctx.fillRect(
              Math.floor(c * moduleSize),
              Math.floor(r * moduleSize),
              Math.ceil(moduleSize),
              Math.ceil(moduleSize)
            );
          }
        }
      }

      // Draw uploaded image
      if (uploadedImage) {
        const imgW = safeW - 8;
        const imgH = safeH - 8;
        ctx.drawImage(uploadedImage, cx - imgW / 2, cy - imgH / 2, imgW, imgH);
      }

      // Draw center text
      if (centerText) {
        ctx.font = `${fontSize}px Arial`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "black";
        ctx.fillText(centerText, cx, cy);
      }
    }

    function downloadQR() {
      const canvas = document.getElementById("qrCanvas");
      const link = document.createElement("a");
      link.download = "qr_code.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    function resetQR() {
      document.getElementById("qrText").value = "";
      document.getElementById("centerText").value = "";
      document.getElementById("fontSize").value = 20;
      document.getElementById("safeShape").value = "auto";
      document.getElementById("safeWidth").value = "";
      document.getElementById("safeHeight").value = "";
      document.getElementById("imageUpload").value = "";
      uploadedImage = null;
      const canvas = document.getElementById("qrCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>
</body>
</html>
