<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Generator with Safe Zone</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    canvas { margin-top: 20px; border: 1px solid #ddd; }
    .controls { margin-bottom: 10px; }
    label { display: block; margin: 5px 0; }
  </style>
</head>
<body>
  <h2>QR Code Generator with Safe Zone</h2>

  <div class="controls">
    <label>Enter text/URL: <input type="text" id="qrText" placeholder="Enter text or URL"></label>
    <label>Upload Image: <input type="file" id="imageInput" accept="image/*"></label>
    <label>Safe Zone Shape:
      <select id="safeShape">
        <option value="auto">Auto</option>
        <option value="rect">Rectangle</option>
        <option value="circle">Circle</option>
      </select>
    </label>
    <label>Safe Zone Width: <input type="number" id="safeWidth" placeholder="auto"></label>
    <label>Safe Zone Height: <input type="number" id="safeHeight" placeholder="auto"></label>
    <button onclick="generateQR()">Generate</button>
    <button onclick="downloadQR()">Download</button>
    <button onclick="resetQR()">Reset</button>
  </div>

  <canvas id="qrcode"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
  <script>
    let uploadedImage = null;

    document.getElementById("imageInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          uploadedImage = img;
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    function generateQR() {
      const qrText = document.getElementById("qrText").value || " ";
      const safeShape = document.getElementById("safeShape").value;
      const safeWidthInput = parseInt(document.getElementById("safeWidth").value);
      const safeHeightInput = parseInt(document.getElementById("safeHeight").value);

      let qr = qrcode(0, "H");
      qr.addData(qrText);
      qr.make();

      const size = 400;
      const canvas = document.getElementById("qrcode");
      const ctx = canvas.getContext("2d");
      canvas.width = size;
      canvas.height = size;

      const moduleCount = qr.getModuleCount();
      const moduleSize = size / moduleCount;

      ctx.clearRect(0, 0, size, size);
      ctx.imageSmoothingEnabled = false;

      // Safe zone dimensions
      let safeWidth = safeWidthInput || (uploadedImage ? uploadedImage.width : 100);
      let safeHeight = safeHeightInput || (uploadedImage ? uploadedImage.height : 50);

      safeWidth += 8;  // add 4px padding on each side
      safeHeight += 8;

      const safeX = (size - safeWidth) / 2;
      const safeY = (size - safeHeight) / 2;

      // Draw QR code, skipping safe zone
      for (let row = 0; row < moduleCount; row++) {
        for (let col = 0; col < moduleCount; col++) {
          if (!qr.isDark(row, col)) continue;

          const x = col * moduleSize;
          const y = row * moduleSize;

          let inSafeZone = false;

          if (safeShape === "circle") {
            const cx = size / 2;
            const cy = size / 2;
            const radius = Math.min(safeWidth, safeHeight) / 2;
            const mx = x + moduleSize / 2;
            const my = y + moduleSize / 2;
            inSafeZone = Math.hypot(mx - cx, my - cy) < radius;
          } else {
            // default rectangle safe zone
            inSafeZone = x >= safeX && x < safeX + safeWidth && y >= safeY && y < safeY + safeHeight;
          }

          if (!inSafeZone) {
            ctx.fillRect(Math.floor(x), Math.floor(y), Math.ceil(moduleSize), Math.ceil(moduleSize));
          }
        }
      }

      // Draw uploaded image or text inside safe zone
      if (uploadedImage) {
        ctx.drawImage(uploadedImage, safeX, safeY, safeWidth - 8, safeHeight - 8);
      } else if (qrText.trim() !== "") {
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(qrText, size / 2, size / 2);
      }
    }

    function downloadQR() {
      const canvas = document.getElementById("qrcode");
      const link = document.createElement("a");
      link.download = "qrcode.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    function resetQR() {
      uploadedImage = null;
      document.getElementById("qrText").value = "";
      document.getElementById("imageInput").value = "";
      const canvas = document.getElementById("qrcode");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  </script>
</body>
</html>
