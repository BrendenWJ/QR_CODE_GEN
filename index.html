<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Custom QR Code Generator</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  canvas { border: 1px solid #ccc; margin-top: 20px; display: block; }
  label { display: block; margin: 5px 0; }
  .controls { margin-bottom: 10px; }
  .controls input, .controls button, .controls select { margin-right: 5px; margin-bottom: 5px; }
</style>
</head>
<body>
<h2>Custom QR Code Generator</h2>

<div class="controls">
  <!-- QR content input -->
  <label>QR Content:
    <input type="text" id="qrContent" style="width:80%;" value="https://valknutgroup.com/">
  </label>

  <!-- File upload -->
  <label>Upload Image (max 200x200px):
    <input type="file" id="imageUpload" accept="image/*">
  </label>

  <!-- Center text -->
  <label>Center Text:
    <input type="text" id="centerText" placeholder="Optional center text">
  </label>
  <label>Font Color:
    <input type="color" id="fontColor" value="#000000">
  </label>
  <label>Font Size:
    <input type="number" id="fontSize" value="20" min="8" max="100">
  </label>
  <label><input type="checkbox" id="bold"> Bold</label>
  <label><input type="checkbox" id="italic"> Italic</label>
  <label><input type="checkbox" id="underline"> Underline</label>

  <!-- Safe zone options -->
  <label>Safe Zone Shape:
    <select id="safeShape">
      <option value="auto">Auto</option>
      <option value="rect">Rectangle</option>
      <option value="circle">Circle</option>
    </select>
  </label>
  <label>Safe Zone Width:
    <input type="number" id="safeWidth" placeholder="auto" min="10">
  </label>
  <label>Safe Zone Height:
    <input type="number" id="safeHeight" placeholder="auto" min="10">
  </label>

  <!-- Buttons -->
  <button id="generateBtn">Generate</button>
  <button id="resetBtn">Reset</button>
  <button id="downloadBtn">Download</button>
</div>

<canvas id="qrCanvas" width="400" height="400"></canvas>

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
<script>
const canvas = document.getElementById('qrCanvas');
const ctx = canvas.getContext('2d');
let uploadedImage = null;

document.getElementById('imageUpload').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const img = new Image();
    img.onload = () => uploadedImage = img;
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
});

function generateQR() {
  const qrText = document.getElementById('qrContent').value || '';
  const centerText = document.getElementById('centerText').value.trim();
  const fontColor = document.getElementById('fontColor').value;
  let fontSize = parseInt(document.getElementById('fontSize').value, 10);
  const bold = document.getElementById('bold').checked ? 'bold ' : '';
  const italic = document.getElementById('italic').checked ? 'italic ' : '';
  const underline = document.getElementById('underline').checked;
  const shape = document.getElementById('safeShape').value;
  let safeW = parseInt(document.getElementById('safeWidth').value, 10);
  let safeH = parseInt(document.getElementById('safeHeight').value, 10);

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Create QR code
  const qr = qrcode(0, 'M');
  qr.addData(qrText);
  qr.make();
  const count = qr.getModuleCount();
  const moduleSize = canvas.width / count;

  // Auto-safe zone if text or image present
  let safeX = canvas.width / 2, safeY = canvas.height / 2;
  if ((centerText || uploadedImage) && (isNaN(safeW) || isNaN(safeH))) {
    if (centerText) {
      ctx.font = `${italic}${bold}${fontSize}px Arial`;
      const textWidth = ctx.measureText(centerText).width;
      safeW = textWidth + 8;
      safeH = fontSize + 8;
    } else if (uploadedImage) {
      safeW = Math.min(uploadedImage.width, canvas.width / 3) + 8;
      safeH = Math.min(uploadedImage.height, canvas.height / 3) + 8;
    }
  }

  // Draw QR modules skipping safe zone
  ctx.fillStyle = "#000";
  ctx.imageSmoothingEnabled = false;
  for (let r = 0; r < count; r++) {
    for (let c = 0; c < count; c++) {
      if (qr.isDark(r, c)) {
        const x = c * moduleSize;
        const y = r * moduleSize;

        let inSafe = false;
        if ((centerText || uploadedImage) && safeW && safeH) {
          const left = safeX - safeW / 2, top = safeY - safeH / 2;
          if (shape === 'circle' || (shape === 'auto' && centerText)) {
            const dx = x + moduleSize / 2 - safeX;
            const dy = y + moduleSize / 2 - safeY;
            const radius = Math.max(safeW, safeH) / 2;
            if (dx * dx + dy * dy <= radius * radius) inSafe = true;
          } else {
            if (x >= left && x < left + safeW && y >= top && y < top + safeH) inSafe = true;
          }
        }

        if (!inSafe) {
          ctx.fillRect(Math.floor(x), Math.floor(y), Math.ceil(moduleSize), Math.ceil(moduleSize));
        }
      }
    }
  }

  // Draw uploaded image
  if (uploadedImage) {
    const maxImgSize = canvas.width / 3;
    let imgW = uploadedImage.width, imgH = uploadedImage.height;
    if (imgW > imgH && imgW > maxImgSize) {
      imgH *= maxImgSize / imgW; imgW = maxImgSize;
    } else if (imgH > maxImgSize) {
      imgW *= maxImgSize / imgH; imgH = maxImgSize;
    }
    ctx.drawImage(uploadedImage, safeX - imgW / 2, safeY - imgH / 2, imgW, imgH);
  }

  // Draw center text
  if (centerText) {
    ctx.font = `${italic}${bold}${fontSize}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    let textWidth = ctx.measureText(centerText).width;
    while (textWidth > canvas.width * 0.6 && fontSize > 8) {
      fontSize--;
      ctx.font = `${italic}${bold}${fontSize}px Arial`;
      textWidth = ctx.measureText(centerText).width;
    }

    ctx.fillStyle = fontColor;
    ctx.fillText(centerText, safeX, safeY);

    if (underline) {
      ctx.beginPath();
      ctx.moveTo(safeX - textWidth / 2, safeY + fontSize / 2 + 2);
      ctx.lineTo(safeX + textWidth / 2, safeY + fontSize / 2 + 2);
      ctx.strokeStyle = fontColor;
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }
}

document.getElementById('generateBtn').addEventListener('click', generateQR);
document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('qrContent').value = '';
  document.getElementById('centerText').value = '';
  document.getElementById('safeWidth').value = '';
  document.getElementById('safeHeight').value = '';
  uploadedImage = null;
  ctx.clearRect(0,0,canvas.width,canvas.height);
});
document.getElementById('downloadBtn').addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'qrcode.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
});
</script>
</body>
</html>
